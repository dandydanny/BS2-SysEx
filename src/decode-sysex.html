<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Web MIDI Lab - Events</title>
    <meta name="description" content="BS2 - decode sysex">
    <meta name="author" content="francois.georgy@gmail.com">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="bs2.js?kc=1234"></script>
    <style>
        #data {
            font-family: Courier New, Courier, monospace;
        }
    </style>
</head>
<body>

    <h2>BS2 - decode sysex</h2>
    <hr />
    <div id="data"></div>

    <script>
        const SYSEX_START = 0xF0;
        const SYSEX_END = 0xF7;

        var midi = null;  // global MIDIAccess object

        String.prototype.padZero = function (len, c) {
            var s = '', c = c || '0', len = (len || 2) - this.length;
            while (s.length < len) s += c;
            return s + this;
        }

        function v(msb, lsb, mask_msb, mask_lsb) {
            let r = getRightShift(mask_lsb); 
            let s = getSetBits(mask_lsb);
            a = (msb & mask_msb) << s; 
            b = (lsb & mask_lsb) >> r;
            return a + b;
        }

        /**
         * Returns the number of bit 0 before the rightmost bit set to 1.
         * @param {*} v 
         */
        function getRightShift(v) {
            if (!v) return -1;  //means there isn't any 1-bit 
            let i = 0;
            while ((v & 1) == 0) { 
                i++;  
                v = v>>1;
            }
            return i;
        }

        /**
         * return the number of bit set
         */
        function getSetBits(v) {
            for (var c = 0; v; c++) {
                v &= v - 1; // clear the least significant bit set
            }
            return c;
        }

        /**
         * returns a string 
         */
        function rawSysEx(data) {
            s = '';
            for (let i=0; i<data.length; i++) {
                s += data[i].toString(16).padZero(2) + ' ';
                if ((i+1) % 16 == 0) s += '<br />';
            }
            return s;
        }

        /**
         * returns a string 
         */
        function decodeSysEx(data) {    

            console.log('decodeSysEx()');

            s = '';

            for (var prop in BS2.param) {

                //console.log(prop);

                let param = BS2.param[prop];

                if (!hasOwnProperty.call(param, 'sysex')) continue;

                if (!hasOwnProperty.call(param.sysex, 'mask')) continue;

                s += 'mask: ';

                let bytes = new Uint8Array(param.sysex.mask.length);

                if (param.sysex.mask.length < 2) {
                    s += '........ ';
                }

                for (let k=0; k<param.sysex.mask.length; k++) {
                    s += param.sysex.mask[k].toString(2).padZero(8) + ' ';
                }

                s += ' raw value: ';

                if (param.sysex.mask.length < 2) {
                    s += '........ ';
                }

                for (let k=0; k<param.sysex.mask.length; k++) {
                    let b = data[param.sysex.offset + k];
                    b = b & param.sysex.mask[k];
                    bytes[k] = b;
                    s += b.toString(2).padZero(8) + ' ';
                } 

                let param_value = 0;
                if (param.sysex.mask.length == 2) {
                    param_value = v(data[param.sysex.offset], data[param.sysex.offset + 1], param.sysex.mask[0], param.sysex.mask[1])
                    s += ` computed: ${param_value} `;
                }

                s += ' final value: ';

                let final_value = 0;
                if (hasOwnProperty.call(param.sysex, 'transform')) {
                    console.log('compute final value with transform function and raw_value=' + param_value);
                    final_value = param.sysex.transform(param_value);
                    console.log('final value', final_value);
                }

                s += final_value;

                s += ` ${param.description}<br />`;
            }

            console.log('decodeSysEx end');

            return s;
        }

        function handleMessage(event) {
            if (event instanceof MIDIMessageEvent) {
                if (event.data[0] == SYSEX_START) {
                    console.log('sysex message received');
                    $("#data").empty().html(decodeSysEx(event.data));
                }
            }
        }

        function subscribeInputs(midiAccess) {
            var inputs = midiAccess.inputs.values();
            // loop over all available inputs
            for (var input = inputs.next(); input && !input.done; input = inputs.next()) {
                input.value.onmidimessage = handleMessage;
            }
        }

        $(function () {
            navigator.requestMIDIAccess({ sysex: true }).then(onMIDISuccess, onMIDIFailure);
            function onMIDISuccess(midiAccess) {
                console.log("Got access to MIDI");
                midi = midiAccess;
                subscribeInputs(midi);
            }
            function onMIDIFailure(msg) {
                console.log("onMIDIFailure", msg);
            }
        });

    </script>
</body>
</html>